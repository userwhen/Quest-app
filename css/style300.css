/* css/style300.css - V44.0 Page Shell & Scroller Fixes */

/* ============================================================
   SECTION 1. 【全域通用設定】
   ============================================================ */
:root {
    --bg: #2d241f; --panel: #f7e7ce; --panel-dark: #eee0c9;
    --acc: #00897b; --gold: #ffb300; 
    --text: #3e2723; --text-light: #5d4037; 
    --danger: #d32f2f; --success: #2e7d32; --border: #8d6e63;

    --hud-h: 90px; --nav-h: 70px;
    --safe-top: env(safe-area-inset-top, 0px); 
    --safe-bottom: env(safe-area-inset-bottom, 0px);
    --font-std: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    
    --radius-std: 20px; --radius-btn: 15px;

    /* Z-Index Hierarchy */
    --z-sys-alert: 22000;
    --z-toast: 21000;
    --z-hud: 12000;
    --z-modal-high: 9500;
    --z-modal: 9000;
    --z-mask: 8000;
    --z-fab: 7000;
    --z-nav: 1000;
    --z-page: 100;
}

* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
body { margin: 0; padding: 0; background: #000; height: 100vh; width: 100vw; display: flex; justify-content: center; overflow: hidden; font-family: var(--font-std); color: var(--text); }

/* 全域捲動條樣式 */
::-webkit-scrollbar { width: 4px; height: 4px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: transparent; border-radius: 10px; }
.ui-scroller-body:hover::-webkit-scrollbar-thumb, .m-body:hover::-webkit-scrollbar-thumb { background: rgba(141, 110, 99, 0.5); }
.hide-scrollbar::-webkit-scrollbar { display: none; }
.hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

/* 通用排版 */
.scroll-row { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 5px; }

/* ============================================================
   SECTION 2. 【全域通用元件】
   ============================================================ */
.u-btn { display: inline-flex; justify-content: center; align-items: center; border: 1px solid var(--border); border-radius: var(--radius-btn); font-weight: bold; cursor: pointer; transition: all 0.1s; user-select: none; box-shadow: 0 2px 0 rgba(0,0,0,0.1); white-space: nowrap; }
.u-btn:active { transform: translateY(2px); box-shadow: none; }
.u-btn-sm { padding: 4px 10px; font-size: 0.9rem; min-width: auto; }
.u-btn-md { height: 40px; padding: 0 20px; font-size: 0.95rem; min-width: 80px; }
.u-btn-lg { height: 50px; padding: 0 24px; font-size: 1.1rem; min-width: 100px; }

.u-btn-primary { background: var(--acc); color: #fff; border-color: #00695c; }
.u-btn-danger { background: #ffebee; color: var(--danger); border-color: #ef9a9a; }
.u-btn-secondary { background: #fff; color: var(--text); }
.u-btn-ghost { background: transparent; border-color: transparent; box-shadow: none; color: var(--text); padding: 4px; }
.u-btn-ghost:active { transform: scale(0.95); }

/* 滑動標籤 */
.u-chip { padding: 6px 14px; border-radius: 20px; border: 1px solid #ccc; background: #f0f0f0; color: #666; font-weight: bold; font-size: 0.9rem; cursor: pointer; white-space: nowrap; flex-shrink: 0; }
.u-chip.active { background: var(--acc); color: #fff; border-color: var(--acc); box-shadow: 0 2px 4px rgba(0,0,0,0.2); }

/* 進度條 */
.u-progress-box { position: relative; width: 100%; background: rgba(0, 0, 0, 0.2); border-radius: 10px; overflow: hidden; border: 1px solid rgba(0,0,0,0.1); box-shadow: inset 0 1px 3px rgba(0,0,0,0.2); }
.u-progress-fill { height: 100%; transition: width 0.3s ease-out; background: var(--acc); }
.u-progress-text { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; font-size: 0.75rem; font-weight: bold; color: #fff; text-shadow: 0 0 3px rgba(0,0,0,0.8), 1px 1px 0 #000; z-index: 2; white-space: nowrap; }

/* ============================================================
   SECTION 3. 【系統框架外殼】
   ============================================================ */
#app-shell { width: 100%; max-width: 480px; height: 100%; background: var(--panel); position: relative; display: flex; flex-direction: column; box-shadow: 0 0 30px rgba(0,0,0,0.5); }

#app-hud { height: var(--hud-h); flex-shrink: 0; background: linear-gradient(180deg, #4e342e, #3e2723); color: #fff; display: flex; align-items: center; padding: 0 10px; border-bottom: 3px solid #2d1b15; z-index: var(--z-hud); gap: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.3); }
.hud-left { flex: 1; display: flex; align-items: center; gap: 8px; min-width: 0; }
.avatar-frame { width: 54px; height: 54px; background: #fff; border: 2px solid var(--acc); border-radius: 50%; overflow: hidden; display: flex; justify-content: center; align-items: center; flex-shrink: 0; box-shadow: 0 0 5px rgba(0,0,0,0.5); }
.hud-info { flex: 1; display: flex; flex-direction: column; justify-content: center; min-width: 0; }
.name { font-weight: bold; font-size: 1rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; text-shadow: 1px 1px 0 #000; }
.lv-row { display: flex; align-items: center; gap: 5px; font-size: 0.8rem; width: 100%; }
.exp-bar-box { flex: 1; height: 8px; background: rgba(0,0,0,0.6); border-radius: 4px; overflow: hidden; border: 1px solid rgba(255,255,255,0.2); }
.exp-bar-fill { height: 100%; background: var(--acc); width: 0%; transition: width 0.3s; }
.hud-right-column { display: flex; flex-direction: column; align-items: flex-end; gap: 4px; flex-shrink: 0; }
.res-pill { background: rgba(0,0,0,0.4); padding: 3px 10px; border-radius: 12px; font-size: 0.8rem; font-weight: bold; border: 1px solid rgba(255,255,255,0.1); display: flex; align-items: center; white-space: nowrap; }
.res-pill.gold { color: var(--gold); min-width: 70px; justify-content: center; }
.res-pill.gem-free { color: #81d4fa; } 
.res-pill.gem-paid { color: #f48fb1; }
.settings-btn { background: transparent; border: none; color: #fff; font-size: 1.8rem; margin-left: 5px; padding: 0 5px; cursor: pointer; flex-shrink: 0; text-shadow: 1px 1px 2px #000; }

#app-nav { height: var(--nav-h); flex-shrink: 0; background: linear-gradient(180deg, #2d241f, #1a100c); display: flex; border-top: 3px solid #4e342e; z-index: var(--z-nav); box-shadow: 0 -2px 10px rgba(0,0,0,0.3); }
.nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #8d6e63; border: none; background: transparent; font-size: 0.8rem; font-weight: bold; }
.nav-item .icon { font-size: 1.5rem; margin-bottom: 2px; filter: grayscale(0.5); transition: all 0.2s; }
.nav-item.active { color: var(--gold); background: rgba(255,255,255,0.05); }
.nav-item.active .icon { filter: grayscale(0); transform: scale(1.1); text-shadow: 0 0 5px var(--gold); }

/* ============================================================
   SECTION 4. 【三大主頁面核心】(FIXED)
   ============================================================ */
#app-main { flex: 1; overflow: hidden; position: relative; width: 100%; }

/* [Fix] 統一使用 .page-shell */
.page-shell { 
    height: 100%; min-height: 0; width: 100%;
    padding: 15px; 
    display: none; flex-direction: column; 
    overflow: hidden; 
}
.page-shell.active { display: flex; }
.page-shell.layer-top { padding: 0; background: var(--bg); position: fixed; top: 0; left: 0; z-index: var(--z-page); }

/* --- 奶蓋滾動結構 (Milk Foam) --- */
/* Header: 固定不變 */
.ui-scroller-fixed { flex-shrink: 0; width: 100%; z-index: 50; padding-bottom: 5px; position: relative; }
/* Body: 負責滾動 */
.ui-scroller-body { flex: 1; overflow-y: auto; overflow-x: hidden; width: 100%; padding: 0 5px; min-height: 0; position: relative; }

/* 任務列表 */
#task-list { flex: 1; display: flex; flex-direction: column; min-height: 0; overflow: hidden; width: 100%; }
#task-cat-scroll, #create-cat-scroll { position: relative; z-index: 51; pointer-events: auto; }

/* 任務卡片 */
.t-card { background: #fff8e1; padding: 12px; border-radius: var(--radius-std); margin-bottom: 10px; border: 1px solid var(--border); box-shadow: 2px 2px 5px rgba(0,0,0,0.1); border-left: 4px solid #ccc; display: flex; flex-direction: column; gap: 8px; position: relative; z-index: 1; flex-shrink: 0; }
.t-card.done { opacity: 0.7; filter: grayscale(0.3); background: #eee; }
.chk { width: 30px; height: 30px; border: 2px solid var(--border); border-radius: 50%; flex-shrink: 0; position: relative; background: rgba(255,255,255,0.5); transition: all 0.2s; cursor: pointer; margin-right: 5px; }
.chk.visually-checked { background: var(--acc); border-color: var(--acc); }
.chk.visually-checked::after { content: '✓'; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #fff; font-size: 18px; font-weight: bold; }

/* 商店與大廳 */
.main-scene { height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; }
.char-stage { flex: 1; display: flex; align-items: flex-end; justify-content: center; padding-bottom: 20px; }
.grid-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 10px; padding: 10px; }
.s-item { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; padding: 8px; text-align: center; cursor: pointer; }
.npc-area { display: flex; align-items: center; padding: 10px; background: #222; border-bottom: 1px solid #444; }
.npc-avatar { font-size: 2.5rem; margin-right: 10px; }
.npc-bubble { background: #fff; color: #000; padding: 5px 10px; border-radius: 10px; font-size: 0.9rem; position: relative; }

/* ============================================================
   SECTION 5. 【功能模組】(FIXED STORY)
   ============================================================ */
/* 彈窗 */
.mask { position: absolute; top: var(--hud-h); height: calc(100% - var(--hud-h) - var(--nav-h)); width: 100%; background: rgba(0,0,0,0.6); z-index: var(--z-mask); display: none; justify-content: center; align-items: center; backdrop-filter: blur(2px); overflow: hidden; }
.mask.active { display: flex; }
.modal { background: #fffbf0; width: 90%; max-width: 400px; border-radius: var(--radius-std); border: 2px solid var(--border); box-shadow: 0 10px 30px rgba(0,0,0,0.5); display: flex; flex-direction: column; max-height: 95%; height: auto; margin: 10px; z-index: var(--z-modal); overflow: hidden; }
.m-head { flex-shrink: 0; background: var(--panel); color: var(--text); padding: 12px 15px; font-weight: bold; display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid var(--border); }
.m-body { flex: 1; overflow-y: auto; min-height: 0; padding: 15px; color: var(--text); text-align: left; }
.m-foot { flex-shrink: 0; background: var(--panel); border-top: 2px solid var(--border); padding: 15px 15px; display: flex; justify-content: flex-end; gap: 10px; }

/* 劇情模式 (Story Mode) */
/* 確保 page-story 佔滿空間 */
#page-story, .story-layout-container { display: flex; flex-direction: column; height: 100%; background: #1a1a1a; position: relative; overflow: hidden; color: #fff; }

.story-header { flex-shrink: 0; height: 50px; background: rgba(0,0,0,0.7); backdrop-filter: blur(8px); display: flex; justify-content: space-between; align-items: center; padding: 0 15px; border-bottom: 1px solid #444; z-index: 100; }

/* [Fix] 中間舞台：填滿 ui-scroller-body */
.story-stage-area { flex: 1; display: flex; flex-direction: column; position: relative; overflow: hidden; min-height: 0; height: 100%; }

.story-stage { flex: 1; display: flex; justify-content: space-around; align-items: flex-end; padding: 0 10px; background: linear-gradient(to top, rgba(0,0,0,0.8), transparent); pointer-events: none; z-index: 1; }
.stage-char { width: 120px; height: 90%; display: flex; align-items: flex-end; justify-content: center; }
.stage-char img { max-height: 100%; object-fit: contain; }

.story-dialog-container { position: absolute; bottom: 80px; left: 0; width: 100%; padding: 0 20px; z-index: 10; pointer-events: none; }
.story-dialog-box { pointer-events: auto; height: 120px; background: rgba(0,0,0,0.8); border: 2px solid #fff; border-radius: 10px; padding: 10px; color: #fff; font-size: 1rem; line-height: 1.5; overflow-y: auto; box-shadow: 0 0 10px #000; }

.story-actions { flex-shrink: 0; background: #111; border-top: 1px solid #3e2723; padding: 10px; min-height: 70px; display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; align-items: center; z-index: 100; }

.btn-story-entry { flex: 1; padding: 12px; background: #5d4037; color: white; border: none; border-radius: 8px; font-size: 1rem; font-weight: bold; cursor: pointer; min-width: 120px; }
.btn-story-opt { background: transparent !important; border: 1px solid var(--acc) !important; color: var(--acc) !important; min-width: 120px; padding: 8px 15px; border-radius: 8px; font-weight: bold; }
.btn-story-opt:active { background: var(--acc) !important; color: #fff !important; }

/* 其他 */
.fab { position: absolute; bottom: calc(var(--nav-h) + 20px); right: 20px; width: 60px; height: 60px; border-radius: 50%; background: var(--acc); color: #fff; border: 2px solid #fff; font-size: 2rem; font-weight: bold; box-shadow: 0 4px 10px rgba(0,0,0,0.4); display: none; justify-content: center; align-items: center; z-index: var(--z-fab); cursor: pointer; transition: transform 0.2s; }
.fab:active { transform: scale(0.95); }
.u-toast { position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%); background: rgba(45, 36, 31, 0.9); color: #fff; padding: 10px 20px; border-radius: 20px; font-size: 0.9rem; z-index: var(--z-toast); opacity: 0; transition: opacity 0.3s; pointer-events: none; border: 1px solid var(--gold); box-shadow: 0 5px 15px rgba(0,0,0,0.5); }
.u-toast.show { opacity: 1; }

.inp { width: 100%; padding: 10px; margin-bottom: 10px; background: rgba(0,0,0,0.05); border: 1px solid var(--border); border-bottom: 2px solid var(--border); border-radius: var(--radius-std); font-size: 1rem; color: var(--text); font-family: var(--font-std); }
.inp:focus { outline: none; border-color: var(--acc); background: #fff; }
.section-title { font-size: 1rem; font-weight: bold; color: var(--text-light); margin-bottom: 8px; display: block; }
.box-gray { background: #f2efe9; padding: 10px; border-radius: var(--radius-std); border: 1px solid rgba(141, 110, 99, 0.2); margin-bottom: 15px; }
.btn-clean { background: transparent; border: none; box-shadow: none; font-size: 1.2rem; cursor: pointer; padding: 5px; color: var(--text); display: flex; align-items: center; justify-content: center; opacity: 0.8; }